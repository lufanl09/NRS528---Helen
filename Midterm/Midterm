###############
# Helen Liu - 528 Midterm

# For this midterm, I want to find the average number of days with good air quality for each state. I started by
# creating a list of all the states in the csv file. Then, I used that list to split the csv file by state into separate
# files. Next, I created calculated the average for each state and created a new file with the result.
# The file used for this assignment is called annual_aqi_by_county_2022.csv. It is downloaded from the EPA website.
###############

### Import modules
import os
import csv
import glob

### Set directory - THIS NEEDS TO BE CHANGED
input_directory = r"C:\NRS528\midterm"
csv_file = "annual_aqi_by_county_2022.csv"

keep_temp_files = True

# Creating folders to store temporary files
if not os.path.exists(os.path.join(input_directory, "state_csv_files")):
    os.mkdir(os.path.join(input_directory, "state_csv_files"))

### Create a list of states from the csv file
state_list = []

with open(os.path.join(input_directory, csv_file)) as annual_aqi:
    header = next(annual_aqi)
    print("Header for " + csv_file + ": " + header)

    for row in csv.reader(annual_aqi, delimiter=","):
        state = row[0]
        if state not in state_list:
            state_list.append(state)
    print("There are " + str(len(state_list)) + " states in the file.")

### Split the file by states
for state in state_list:
    state_count = 1
    with open(os.path.join(input_directory, csv_file)) as annual_aqi:
        for row in csv.reader(annual_aqi):
            if row[0] == state:
                if state_count == 1:
                    file = open(os.path.join(input_directory, "state_csv_files", state + "2022.csv"), "w")
                    file.write(header)
                    state_count = 0
                file.write(",".join(row))
                file.write("\n")
    file.close()

### After files are created, we can find the average number of good days by state
# Change directory to the folder where all state files are stored
os.chdir(os.path.join(input_directory, "state_csv_files"))
state_file_list = glob.glob("*.csv")      # Find all CSV files in the directory
print("There are " + str(len(state_file_list)) + " CSV files.")

state_directory = input_directory + r"\state_csv_files"
avg_directory = input_directory + r"\average"

# Another way to make a new directory that stores the final file created
os.mkdir(avg_directory)

avg_file = open(os.path.join(avg_directory, "avg_good_days.csv"), "w")
avg_file.write("State, Average Good Days")
avg_file.write("\n")

for state_file in state_file_list:
    print("Processing: " + str(state_file))

    with open(os.path.join(state_directory, state_file)) as state_csv:
        sum_good_days = 0
        county = 0
        for row in csv.reader(state_csv):
            if county > 0:
                good_days = row[4]
                sum_good_days += int(good_days)
            county += 1
    avg_good_days = sum_good_days/(county-1)
    print(avg_good_days)

    avg_file.write(row[0] + "," + str(avg_good_days))
    avg_file.write("\n")

    print("We wrote that " + str(row[0]) + " " + str(avg_good_days))

avg_file.close()


